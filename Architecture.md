│ AD Lab Environment - Implementation Plan                                                                                                                                                                                │
│                                                                                                                                                                                                                         │
│ Context                                                                                                                                                                                                                 │
│                                                                                                                                                                                                                         │
│ Build an Azure-based Active Directory lab for testing Entra Sync, Entra Cloud Sync, and Global Secure Access (GSA). The lab deploys 2 DCs (primary + failover) and 2 app servers across 2 Azure regions, with 100 AD    │
│ users across 6 departments. All infrastructure via BICEP; Python for user generation.                                                                                                                                   │
│                                                                                                                                                                                                                         │
│ Architecture Summary                                                                                                                                                                                                    │
│                                                                                                                                                                                                                         │
│ ┌───────────────────────┬────────────────┬──────────────────┬───────────────────────────┬────────────┐                                                                                                                  │
│ │       Resource        │     Region     │  Resource Group  │        VNet/Subnet        │ Private IP │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ DVDC01 (Primary DC)   │ eastus2        │ rg-ADLab-East    │ 10.1.0.0/16 / 10.1.1.0/24 │ 10.1.1.4   │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ DVAS01 (App Server)   │ eastus2        │ rg-ADLab-East    │ 10.1.0.0/16 / 10.1.2.0/24 │ 10.1.2.4   │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ Bastion East          │ eastus2        │ rg-ADLab-East    │ 10.1.0.0/16 / 10.1.3.0/24 │ -          │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ DVDC02 (Secondary DC) │ northcentralus │ rg-ADLab-Central │ 10.2.0.0/16 / 10.2.1.0/24 │ 10.2.1.4   │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ DVAS02 (App Server)   │ northcentralus │ rg-ADLab-Central │ 10.2.0.0/16 / 10.2.2.0/24 │ 10.2.2.4   │                                                                                                                  │
│ ├───────────────────────┼────────────────┼──────────────────┼───────────────────────────┼────────────┤                                                                                                                  │
│ │ Bastion Central       │ northcentralus │ rg-ADLab-Central │ 10.2.0.0/16 / 10.2.3.0/24 │ -          │                                                                                                                  │
│ └───────────────────────┴────────────────┴──────────────────┴───────────────────────────┴────────────┘                                                                                                                  │
│                                                                                                                                                                                                                         │
│ - Domain: managed-connections.net (NetBIOS: MANAGEDCONN)                                                                                                                                                                │
│ - VM Size: Standard_B2s | OS: Windows Server 2022 Datacenter                                                                                                                                                            │
│ - VNet Peering: Bidirectional between East and Central                                                                                                                                                                  │
│ - Access: Azure Bastion + Public IPs with NSG RDP rules                                                                                                                                                                 │
│                                                                                                                                                                                                                         │
│ Project Structure                                                                                                                                                                                                       │
│                                                                                                                                                                                                                         │
│ AD-Lab/                                                                                                                                                                                                                 │
│ ├── bicep/                                                                                                                                                                                                              │
│ │   ├── main.bicep                    # Top-level orchestrator                                                                                                                                                          │
│ │   ├── main.bicepparam               # Parameters                                                                                                                                                                      │
│ │   └── modules/                                                                                                                                                                                                        │
│ │       ├── network/                                                                                                                                                                                                    │
│ │       │   ├── vnet.bicep            # VNet + subnets                                                                                                                                                                  │
│ │       │   ├── nsg.bicep             # Network security groups                                                                                                                                                         │
│ │       │   ├── nsg-bastion.bicep     # Bastion-specific NSG rules                                                                                                                                                      │
│ │       │   ├── peering.bicep         # VNet peering (one direction)                                                                                                                                                    │
│ │       │   └── bastion.bicep         # Bastion host + PIP                                                                                                                                                              │
│ │       ├── compute/                                                                                                                                                                                                    │
│ │       │   ├── vm.bicep              # Generic Windows VM                                                                                                                                                              │
│ │       │   └── vm-extension.bicep    # Custom Script Extension                                                                                                                                                         │
│ │       └── storage/                                                                                                                                                                                                    │
│ │           └── storageaccount.bicep  # Script hosting                                                                                                                                                                  │
│ ├── scripts/                                                                                                                                                                                                            │
│ │   ├── powershell/                                                                                                                                                                                                     │
│ │   │   ├── Promote-PrimaryDC.ps1     # Install AD DS + create forest                                                                                                                                                   │
│ │   │   ├── Promote-SecondaryDC.ps1   # Install AD DS + replicate                                                                                                                                                       │
│ │   │   ├── Join-DomainAndConfigure.ps1  # Domain join + IIS + File Server                                                                                                                                              │
│ │   │   ├── Configure-OUs.ps1        # Create OU hierarchy                                                                                                                                                              │
│ │   │   ├── Create-ADUsers.ps1       # Import users from CSV                                                                                                                                                            │
│ │   │   └── Configure-DNS-Forwarders.ps1  # Add Azure DNS forwarder post-promotion                                                                                                                                      │
│ │   └── python/                                                                                                                                                                                                         │
│ │       ├── requirements.txt          # faker                                                                                                                                                                           │
│ │       ├── generate_users.py         # Generate 100 users → CSV + JSON                                                                                                                                                 │
│ │       └── data/                     # Generated output                                                                                                                                                                │
│ ├── deploy/                                                                                                                                                                                                             │
│ │   └── deploy.ps1                    # 7-phase deployment orchestrator                                                                                                                                                 │
│ └── .gitignore                                                                                                                                                                                                          │
│                                                                                                                                                                                                                         │
│ Implementation Steps                                                                                                                                                                                                    │
│                                                                                                                                                                                                                         │
│ Step 1: Project scaffolding                                                                                                                                                                                             │
│                                                                                                                                                                                                                         │
│ - Create directory structure                                                                                                                                                                                            │
│ - Create .gitignore (exclude .venv/, *.csv, *.json in data/, *.parameters.json with secrets)                                                                                                                            │
│ - Initialize git repo                                                                                                                                                                                                   │
│ - Create Python venv at scripts/python/.venv, install faker                                                                                                                                                             │
│                                                                                                                                                                                                                         │
│ Step 2: BICEP modules — Networking                                                                                                                                                                                      │
│                                                                                                                                                                                                                         │
│ - modules/network/vnet.bicep — VNet with parameterized subnets array. DNS servers configurable (default empty = Azure DNS)                                                                                              │
│ - modules/network/nsg.bicep — Parameterized NSG with security rules array. Default rules: RDP inbound, HTTPS inbound                                                                                                    │
│ - modules/network/nsg-bastion.bicep — Bastion-required NSG (443 from GatewayManager, 8080/5701 VirtualNetwork, 3389/22 outbound)                                                                                        │
│ - modules/network/peering.bicep — Single-direction peering module (called twice)                                                                                                                                        │
│ - modules/network/bastion.bicep — Bastion host + Standard SKU static PIP                                                                                                                                                │
│                                                                                                                                                                                                                         │
│ Step 3: BICEP modules — Compute                                                                                                                                                                                         │
│                                                                                                                                                                                                                         │
│ - modules/compute/vm.bicep — Generic Windows Server 2022 VM: NIC (static or dynamic IP), optional PIP, NSG association, OS disk, optional data disk. Image:                                                             │
│ MicrosoftWindowsServer/WindowsServer/2022-datacenter-azure-edition                                                                                                                                                      │
│ - modules/compute/vm-extension.bicep — Reusable Custom Script Extension: takes script URI + command to execute with protected settings                                                                                  │
│                                                                                                                                                                                                                         │
│ Step 4: BICEP modules — Storage                                                                                                                                                                                         │
│                                                                                                                                                                                                                         │
│ - modules/storage/storageaccount.bicep — Storage account + blob container (scripts) for hosting PowerShell scripts                                                                                                      │
│                                                                                                                                                                                                                         │
│ Step 5: BICEP main + parameters                                                                                                                                                                                         │
│                                                                                                                                                                                                                         │
│ - main.bicep — Deploys at subscription scope. Creates resource groups, then module calls for both regions. Supports deployPhase parameter to control which resources deploy (enables phased execution)                  │
│ - main.bicepparam — All non-secret parameters. Secrets passed at deployment time                                                                                                                                        │
│                                                                                                                                                                                                                         │
│ Step 6: PowerShell scripts                                                                                                                                                                                              │
│                                                                                                                                                                                                                         │
│ - Promote-PrimaryDC.ps1 — Install AD-Domain-Services, DNS, GPMC features; Install-ADDSForest for managed-connections.net; auto-reboot                                                                                   │
│ - Promote-SecondaryDC.ps1 — Set DNS client to 10.1.1.4; install features; Install-ADDSDomainController to replicate; auto-reboot                                                                                        │
│ - Join-DomainAndConfigure.ps1 — Set DNS client to local DC; Add-Computer to join domain; register scheduled task to install IIS + File Server roles after reboot                                                        │
│ - Configure-OUs.ps1 — Create OU tree: ADLab → Users → {HR,IT,Legal,Finance,Marketing,Operations} → {Managers,Employees,Contractors}; also Groups, Servers, ServiceAccounts OUs                                          │
│ - Create-ADUsers.ps1 — Import CSV, create AD users with New-ADUser in correct OUs                                                                                                                                       │
│ - Configure-DNS-Forwarders.ps1 — Add 168.63.129.16 as DNS forwarder on DCs                                                                                                                                              │
│                                                                                                                                                                                                                         │
│ Step 7: Python user generator                                                                                                                                                                                           │
│                                                                                                                                                                                                                         │
│ - generate_users.py — Uses faker to create 100 users: ~16-17 per department, distributed across Manager (~2), Employee (~11-12), Contractor (~3-4) roles. Outputs users.csv and users.json with: FirstName, LastName,   │
│ DisplayName, SamAccountName, UPN, Department, Role, OUPath, Password, Enabled                                                                                                                                           │
│                                                                                                                                                                                                                         │
│ Step 8: Deployment orchestrator                                                                                                                                                                                         │
│                                                                                                                                                                                                                         │
│ - deploy/deploy.ps1 — 7-phase script:                                                                                                                                                                                   │
│   a. Infra: RGs, VNets (Azure DNS), NSGs, Bastion, Storage, upload scripts                                                                                                                                              │
│   b. VMs: All 4 VMs (no CSE, standard Azure DNS)                                                                                                                                                                        │
│   c. Primary DC: CSE on DVDC01 → promote → wait for reboot + stabilize                                                                                                                                                  │
│   d. DNS + Peering: Update VNet DNS to DC IPs, create bidirectional peering                                                                                                                                             │
│   e. Secondary DC: CSE on DVDC02 → replicate → wait → update DNS to both DCs                                                                                                                                            │
│   f. App Servers: CSE on DVAS01/DVAS02 → domain join + install roles                                                                                                                                                    │
│   g. AD Config: Run OUs, Users, GPOs via Invoke-AzVMRunCommand                                                                                                                                                          │
│                                                                                                                                                                                                                         │
│ Deployment Dependency Chain                                                                                                                                                                                             │
│                                                                                                                                                                                                                         │
│ Phase 1: RGs + VNets + NSGs + Bastion + Storage                                                                                                                                                                         │
│     ↓                                                                                                                                                                                                                   │
│ Phase 2: All 4 VMs (Azure default DNS, no domain config)                                                                                                                                                                │
│     ↓                                                                                                                                                                                                                   │
│ Phase 3: CSE on DVDC01 → Install-ADDSForest → reboot → wait                                                                                                                                                             │
│     ↓                                                                                                                                                                                                                   │
│ Phase 4: Update VNet DNS to DCs + VNet Peering (both directions)                                                                                                                                                        │
│     ↓                                                                                                                                                                                                                   │
│ Phase 5: CSE on DVDC02 → Install-ADDSDomainController → reboot → wait → update DNS                                                                                                                                      │
│     ↓                                                                                                                                                                                                                   │
│ Phase 6: CSE on DVAS01/DVAS02 → domain join → reboot → install IIS + File Server                                                                                                                                        │
│     ↓                                                                                                                                                                                                                   │
│ Phase 7: OUs → Users (from Python CSV) → GPOs via Invoke-AzVMRunCommand                                                                                                                                                 │
│                                                                                                                                                                                                                         │
│ Key Design Decisions                                                                                                                                                                                                    │
│                                                                                                                                                                                                                         │
│ - Phased DNS: VNets start with Azure default DNS; updated to DC IPs only after DC promotion. Avoids provisioning failures.                                                                                              │
│ - Single CSE per VM: Each VM gets one comprehensive script for its role. Post-reboot tasks use scheduled tasks or Invoke-AzVMRunCommand.                                                                                │
│ - Storage for scripts: PowerShell scripts uploaded to blob storage, referenced by CSE via SAS-protected URIs.                                                                                                           │
│ - Sync left manual: Entra Connect/Cloud Sync infra not automated — VMs are provisioned ready for manual agent installation.                                                                                             │
│                                                                                                                                                                                                                         │
│ Verification                                                                                                                                                                                                            │
│                                                                                                                                                                                                                         │
│ 1. az deployment sub what-if before each phase                                                                                                                                                                          │
│ 2. After Phase 3: RDP to DVDC01 via Bastion, verify Get-ADForest returns managed-connections.net                                                                                                                        │
│ 3. After Phase 5: repadmin /replsummary on DVDC01 shows healthy replication with DVDC02                                                                                                                                 │
│ 4. After Phase 6: Get-ADComputer -Filter * on DVDC01 shows DVAS01 and DVAS02                                                                                                                                            │
│ 5. After Phase 7: Get-ADUser -Filter * -SearchBase "OU=ADLab,DC=managed-connections,DC=net" returns 100 users                                                                                                           │
│ 6. Test IIS: Browse to DVAS01/DVAS02 private IPs from within VNet                                                                                                                                                       │
│ 7. Test File Share: \\DVAS01\Department accessible from domain-joined machines                                                                                                                                          │
╰─────────────────────────────────────────────────────────────────────────────────